import React, { useState, useEffect, useRef } from "react";
import * as tf from "@tensorflow/tfjs";
import * as mobilenet from "@tensorflow-models/mobilenet";

const MUSIC_CATEGORIES = {
  ethnic: {
    label: "Ethnic/Traditional",
    description:
      "Traditional or ethnic dressing like sari, kurta, folk wear.",
    songs: [
      { title: "Ghoomar", artist: "Hindi Folk", language: "hi" },
      { title: "Laung Gawacha", artist: "Punjabi Folk", language: "pa" },
      { title: "Vaathi Coming", artist: "Tamil Folk", language: "ta" },
      { title: "Zingaat", artist: "Marathi Pop", language: "mr" },
      { title: "Jimikki Kammal", artist: "Malayalam", language: "ml" },
      { title: "Shape of You", artist: "Ed Sheeran", language: "en" },
    ],
  },
  aesthetic: {
    label: "Aesthetic/Soft",
    description: "Pastel tones, makeup, soft and chill mood.",
    songs: [
      { title: "See You Again - LoFi", artist: "Wiz Khalifa", language: "en" },
      { title: "Khwaab", artist: "Hindi Indie", language: "hi" },
      { title: "Samayama", artist: "Telugu Chill", language: "te" },
      { title: "Malare (LoFi)", artist: "Malayalam", language: "ml" },
      { title: "Someone Like You", artist: "Adele", language: "en" },
    ],
  },
  rock: {
    label: "Rock/Grunge",
    description:
      "Dark clothing, leather jackets, and edgy style.",
    songs: [
      { title: "Rock On!!", artist: "Hindi Rock", language: "hi" },
      { title: "Naa Ready", artist: "Tamil Rock Kuthu", language: "ta" },
      { title: "Sadda Haq", artist: "Hindi Rock", language: "hi" },
      { title: "Kannada Gothilla", artist: "Kannada Alt Rock", language: "kn" },
      { title: "Smells Like Teen Spirit", artist: "Nirvana", language: "en" },
    ],
  },
  dance: {
    label: "Dance/Club",
    description: "Energetic dance, stage environment, party mood.",
    songs: [
      { title: "Ghungroo", artist: "Hindi Dance Pop", language: "hi" },
      { title: "Butta Bomma", artist: "Telugu Dance", language: "te" },
      { title: "Arabic Kuthu", artist: "Tamil Dance", language: "ta" },
      { title: "The Humma Song", artist: "Hindi EDM", language: "hi" },
      { title: "Uptown Funk", artist: "Mark Ronson ft Bruno Mars", language: "en" },
    ],
  },
  energetic: {
    label: "Energetic/Upbeat",
    description:
      "Bright colors, sportswear, and lively actions.",
    songs: [
      { title: "Believer", artist: "Imagine Dragons", language: "en" },
      { title: "Malhari", artist: "Hindi", language: "hi" },
      { title: "Rowdy Baby", artist: "Tamil", language: "ta" },
      { title: "Mind Block", artist: "Telugu", language: "te" },
      { title: "Dheera Dheera", artist: "Kannada KGF", language: "kn" },
    ],
  },
};

// Utility to extract dominant colors from canvas pixels
function getDominantColors(imageData, count = 5) {
  const colorMap = new Map();
  const data = imageData.data;
  for (let i = 0; i < data.length; i += 4 * 10) {
    const r = data[i];
    const g = data[i + 1];
    const b = data[i + 2];
    const key = `${r},${g},${b}`;
    colorMap.set(key, (colorMap.get(key) || 0) + 1);
  }
  // Sort by frequency and take top count
  const sortedColors = [...colorMap.entries()]
    .sort((a, b) => b[1] - a[1])
    .slice(0, count)
    .map((c) => c[0]);
  return sortedColors;
}

function rgbToHex(rgb) {
  const [r, g, b] = rgb.split(",").map(Number);
  return (
    "#" +
    [r, g, b]
      .map((x) => {
        const hex = x.toString(16);
        return hex.length === 1 ? "0" + hex : hex;
      })
      .join("")
  );
}

function calculateBrightness(r, g, b) {
  // Using formula for luminance perception: 
  return (0.299 * r + 0.587 * g + 0.114 * b);
}

function calculateSaturation(r, g, b) {
  const max = Math.max(r, g, b);
  const min = Math.min(r, g, b);
  if(max === 0) return 0;
  return (max - min) / max;
}

function calculateColorfulness(r, g, b) {
  // Simple approach: max-min difference
  return Math.abs(r - g) + Math.abs(g - b) + Math.abs(b - r);
}

export default function InstagramMusicMatcher() {
  const [model, setModel] = useState(null);
  const [imageSrc, setImageSrc] = useState(null);
  const [loading, setLoading] = useState(false);
  const [dominantColors, setDominantColors] = useState([]);
  const [brightness, setBrightness] = useState(0);
  const [saturation, setSaturation] = useState(0);
  const [colorfulness, setColorfulness] = useState(0);
  const [detectedCategory, setDetectedCategory] = useState(null);
  const [predictions, setPredictions] = useState([]);
  const fileInputRef = useRef(null);
  const canvasRef = useRef(null);
  const [theme, setTheme] = useState("light");

  useEffect(() => {
    // Load MobileNet model
    setLoading(true);
    mobilenet.load()
      .then(m => { 
        setModel(m);
        setLoading(false);
      });
  }, []);

  useEffect(() => {
    document.body.dataset.theme = theme;
  }, [theme]);

  const handleImageUpload = (event) => {
    const file = event.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      setImageSrc(e.target.result);
      setDetectedCategory(null);
      setPredictions([]);
      setDominantColors([]);
      setBrightness(0);
      setSaturation(0);
      setColorfulness(0);

      // After image is loaded into img element, process it
      setTimeout(() => {
        analyzeImage(e.target.result);
      }, 100);
    };
    reader.readAsDataURL(file);
  };

  const analyzeImage = async (src) => {
    if (!model) return;
    setLoading(true);

    // Load image into canvas for pixel data extraction
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.src = src;
    img.onload = async () => {
      const canvas = canvasRef.current;
      const ctx = canvas.getContext("2d");

      // Resize image to max 224x224 (MobileNet input size)
      let width = img.width;
      let height = img.height;
      const maxDim = 224;
      if (width > height && width > maxDim) {
        height = Math.round((height * maxDim) / width);
        width = maxDim;
      } else if (height > maxDim) {
        width = Math.round((width * maxDim) / height);
        height = maxDim;
      }
      canvas.width = width;
      canvas.height = height;
      ctx.clearRect(0, 0, width, height);
      ctx.drawImage(img, 0, 0, width, height);

      // Extract pixel data for color analysis
      const imageData = ctx.getImageData(0, 0, width, height);
      const colors = getDominantColors(imageData, 5);
      setDominantColors(colors);

      // Aggregate brightness, saturation & colorfulness over dominant colors
      let sumBrightness = 0;
      let sumSaturation = 0;
      let sumColorfulness = 0;
      colors.forEach((c) => {
        const [r, g, b] = c.split(",").map(Number);
        sumBrightness += calculateBrightness(r, g, b);
        sumSaturation += calculateSaturation(r, g, b);
        sumColorfulness += calculateColorfulness(r, g, b);
      });
      setBrightness(Math.round(sumBrightness / colors.length));
      setSaturation(sumSaturation / colors.length);
      setColorfulness(sumColorfulness / colors.length);

      // Run MobileNet prediction
      const predictions = await model.classify(img);
      setPredictions(predictions);

      // Determine category from predictions and color stats
      const category = determineMusicCategory(predictions, sumBrightness / colors.length, sumSaturation / colors.length, sumColorfulness / colors.length);

      setDetectedCategory(category);

      setLoading(false);
    };
  };

  // Logic to determine music category based on detected objects and image stats
  const determineMusicCategory = (predictions, avgBrightness, avgSaturation, avgColorfulness) => {
    // Helper - check if prediction class includes keywords related to categories
    const labels = predictions.map((p) => p.className.toLowerCase());

    // Ethnic keywords
    if (
      labels.some((l) => 
        ["sari", "kimono", "abaya", "cloak", "gown"].some((k) => l.includes(k))
      )
    ) {
      return "ethnic";
    }

    // Aesthetic: pastel colors and makeup items
    if (
      labels.some((l) => ["lipstick", "lip", "eyeshadow", "cosmetics", "powder"].some((k) => l.includes(k))) ||
      (avgBrightness >= 50 && avgBrightness <= 80 && avgSaturation <= 0.5)
    ) {
      return "aesthetic";
    }

    // Rock if dark clothing or leather jacket references or overall dark image
    if (
      labels.some((l) => ["leather jacket", "jacket", "motorcycle", "guitar", "bandana"].some((k) => l.includes(k))) ||
      avgBrightness < 45
    ) {
      return "rock";
    }

    // Dance/Club: stage, microphone, colorful, high saturation
    if (
      labels.some((l) => ["microphone", "stage", "disco ball", "dance floor"].some((k) => l.includes(k))) ||
      avgColorfulness > 70
    ) {
      return "dance";
    }

    // Energetic/upbeat: sports, bright colors
    if (
      labels.some((l) => ["jersey", "sports", "ball", "running shoe"].some((k) => l.includes(k))) ||
      (avgBrightness > 70 && avgSaturation > 0.4)
    ) {
      return "energetic";
    }

    // Fallback category
    return "aesthetic";
  };

  const toggleTheme = () => {
    setTheme(theme === "light" ? "dark" : "light");
  };

  return (
    <div className="app-container">
      <header>
        <h1>Instagram Music Matcher</h1>
        <button onClick={toggleTheme} aria-label="Toggle Dark/Light Mode" className="theme-toggle">
          {theme === "light" ? "üåô Dark Mode" : "‚òÄÔ∏è Light Mode"}
        </button>
      </header>

      <main>
        <section className="upload-section">
          <input
            type="file"
            accept="image/*"
            onChange={handleImageUpload}
            ref={fileInputRef}
            aria-label="Upload image"
          />
          {loading && <p className="loading">Analyzing image & recommending music...</p>}
          {imageSrc && (
            <figure className="uploaded-image">
              <img src={imageSrc} alt="Uploaded visual for analysis" />
              <figcaption>Uploaded Image Preview</figcaption>
            </figure>
          )}
        </section>

        {imageSrc && (
          <section className="analysis-section" aria-live="polite" aria-atomic="true">
            <h2>Image Analysis</h2>
            <canvas ref={canvasRef} style={{ display: "none" }}></canvas>

            <div className="color-info">
              <h3>Dominant Colors</h3>
              <ul className="color-swatches">
                {dominantColors.map((c, i) => (
                  <li key={i} style={{ backgroundColor: rgbToHex(c), color: "#fff" }} aria-label={`Color swatch ${rgbToHex(c)}`}>
                    {rgbToHex(c)}
                  </li>
                ))}
              </ul>
            </div>

            <div className="color-metrics">
              <p><strong>Brightness:</strong> {brightness}</p>
              <p><strong>Saturation:</strong> {(saturation * 100).toFixed(0)}%</p>
              <p><strong>Colorfulness:</strong> {colorfulness}</p>
            </div>

            <div className="ml-predictions" aria-live="polite" aria-atomic="true">
              <h3>Detected Objects / Themes</h3>
              <ul>
                {predictions.length === 0 && <li>No objects detected</li>}
                {predictions.map((p, i) => (
                  <li key={i}>{p.className} - {(p.probability * 100).toFixed(2)}%</li>
                ))}
              </ul>
            </div>

            <div className="music-recommendations">
              <h2>Music Recommendations</h2>
              {detectedCategory && (
                <>
                  <h3>{MUSIC_CATEGORIES[detectedCategory].label}</h3>
                  <p className="category-desc">{MUSIC_CATEGORIES[detectedCategory].description}</p>
                  <ul className="song-list" role="list">
                    {MUSIC_CATEGORIES[detectedCategory].songs.map(({ title, artist, language }, idx) => (
                      <li key={idx} className="song-card">
                        <div className="song-title">{title}</div>
                        <div className="song-artist">{artist}</div>
                        <div className="song-language">{language.toUpperCase()}</div>
                      </li>
                    ))}
                  </ul>
                </>
              )}
            </div>
          </section>
        )}

        {!imageSrc && !loading && (
          <section className="welcome-section" aria-live="polite">
            <p>Please upload an image to get music recommendations matched to your Instagram post's style and mood.</p>
          </section>
        )}
      </main>

      <footer>
        <small>
          ¬© 2025 Instagram Music Matcher ‚Äî AI-Powered Recommendations for Your Visual Content
        </small>
      </footer>

      <style>{`
        :root {
          --color-light-bg: #f9f9f9;
          --color-light-text: #222;
          --color-dark-bg: #121212;
          --color-dark-text: #e0e0e0;
          --primary-color: #FF5722;
          --secondary-color: #2196F3;
          --max-width: 720px;
        }
        body[data-theme="light"] {
          background-color: var(--color-light-bg);
          color: var(--color-light-text);
        }
        body[data-theme="dark"] {
          background-color: var(--color-dark-bg);
          color: var(--color-dark-text);
        }
        .app-container {
          max-width: var(--max-width);
          margin: 1rem auto;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          padding: 1rem;
        }
        header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1.5rem;
        }
        header h1 {
          margin: 0;
          font-size: 1.5rem;
          color: var(--primary-color);
        }
        .theme-toggle {
          background: none;
          border: none;
          cursor: pointer;
          font-size: 1rem;
          color: var(--secondary-color);
          padding: 0.25rem 0.5rem;
          border-radius: 4px;
          transition: background-color 0.3s;
        }
        .theme-toggle:hover {
          background-color: var(--secondary-color);
          color: white;
        }
        input[type="file"] {
          border: 2px dashed var(--primary-color);
          border-radius: 6px;
          padding: 1rem;
          width: 100%;
          cursor: pointer;
          color: var(--primary-color);
          font-weight: 600;
          font-size: 1rem;
          margin-bottom: 1rem;
        }
        .upload-section {
          text-align: center;
        }
        .uploaded-image img {
          max-width: 100%;
          border-radius: 8px;
          margin-bottom: 0.25rem;
          box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .loading {
          margin: 1rem 0;
          font-weight: 600;
          font-style: italic;
          color: var(--secondary-color);
        }
        .analysis-section h2,
        .music-recommendations h2 {
          margin-top: 2rem;
          border-bottom: 2px solid var(--primary-color);
          padding-bottom: 0.25rem;
        }
        .color-swatches {
          list-style: none;
          padding: 0;
          display: flex;
          gap: 0.5rem;
          margin-bottom: 1rem;
          flex-wrap: wrap;
        }
        .color-swatches li {
          width: 50px;
          height: 50px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 0.75rem;
          text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
          border-radius: 6px;
          font-family: monospace;
        }
        .color-metrics p {
          margin: 0.25rem 0;
        }
        .ml-predictions ul {
          list-style-type: disc;
          padding-left: 1.5rem;
        }
        .music-recommendations ul.song-list {
          list-style: none;
          padding: 0;
          margin-top: 0.5rem;
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 0.75rem;
        }
        .song-card {
          border: 2px solid var(--primary-color);
          border-radius: 8px;
          padding: 0.75rem 1rem;
          background-color: rgba(255 87 34 / 0.1);
          display: flex;
          flex-direction: column;
          justify-content: center;
        }
        .song-title {
          font-weight: 700;
          font-size: 1rem;
          margin-bottom: 0.2rem;
        }
        .song-artist, .song-language {
          font-size: 0.85rem;
          color: var(--secondary-color);
        }
        .category-desc {
          font-style: italic;
          margin-bottom: 1rem;
        }
        .welcome-section {
          margin-top: 2rem;
          text-align: center;
          font-size: 1.1rem;
          color: var(--secondary-color);
        }
        footer {
          text-align: center;
          margin-top: 3rem;
          font-size: 0.8rem;
          color: gray;
        }

        @media (max-width: 480px) {
          .music-recommendations ul.song-list {
            grid-template-columns: 1fr;
          }
          header {
            flex-direction: column;
            gap: 0.5rem;
          }
        }
      `}</style>
    </div>
  );
}
